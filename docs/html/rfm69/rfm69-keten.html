
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="nl">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>RFM69 keten &#8212; iot-0  documentatie</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Zoeken" href="../search.html" />
    <link rel="next" title="Opdrachten" href="opdrachten.html" />
    <link rel="prev" title="RFM69-knopen" href="../rfm69.html" />

<script type="application/json" class="js-hypothesis-config">
{
"showHighlights": false
}
</script>
<script async src="https://hypothes.is/embed.js"></script>


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">iot-0</a></h1>








<h3>Navigatie</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../voorwoord.html">Voorwoord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inleiding.html">Inleiding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bouwstenen.html">Bouwstenen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webserver.html">Webserver-knopen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wifi.html">WiFi-MQTT-knopen</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../rfm69.html">RFM69-knopen</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">RFM69 keten</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rfm69-protocol">RFM69 protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gateway">Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="opdrachten.html">Opdrachten</a></li>
<li class="toctree-l2"><a class="reference internal" href="toetsvragen.html">Toetsvragen</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lora.html">LoRa-knopen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configureren.html">Configureren</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ten-geleide.html">Voor de docent</a></li>
</ul>
<p class="caption"><span class="caption-text">Andere modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://infvo.github.io/com-0/">Com-0</a></li>
<li class="toctree-l1"><a class="reference external" href="https://infvo.github.io/iot-1/">IoT-1</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../rfm69.html">RFM69-knopen</a><ul>
      <li>Previous: <a href="../rfm69.html" title="vorig hoofdstuk">RFM69-knopen</a></li>
      <li>Next: <a href="opdrachten.html" title="volgend hoofdstuk">Opdrachten</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Snel zoeken</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Zoek" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rfm69-keten">
<h1>RFM69 keten<a class="headerlink" href="#rfm69-keten" title="Permalink naar deze titel">¶</a></h1>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../_images/IoT-keten-RFM691.png"><img alt="../_images/IoT-keten-RFM691.png" src="../_images/IoT-keten-RFM691.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">De RFM69 keten</span></p>
</div>
<p>We gebruiken een eigen protocol voor de RFM69-radio:
hiermee houden we de pakketten klein, en de software eenvoudig.
Het binaire Cayenne Low Power Payload (LPP) formaat gebruiken we voor de payload.</p>
<p>Een <em>gateway</em> zet dit RFM69/LPP-protocol om in het MQTT/JSON-protocol voor onze IoT-toepassingen.</p>
<p>Op het niveau van onze IoT-toepassingen hebben alle MQTT/JSON-berichten dezelfde structuur:
de berichten van de RFM69-IoT-knopen verwerken we op dezelfde manier als de berichten van de WiFi-knopen.</p>
<p>(We gebruiken voor de IoT-toepassing een JSON-formaat met dezelfde structuur, zie XXX.)</p>
</div>
<div class="section" id="rfm69-protocol">
<h1>RFM69 protocol<a class="headerlink" href="#rfm69-protocol" title="Permalink naar deze titel">¶</a></h1>
<p>We hebben te maken met de volgende <em>protocolstack</em>:</p>
<ul class="simple">
<li>het hardware-protocol (RFM69 radio);</li>
<li>het protocol van de RFM69-library;</li>
<li>het protocol van de IoT-toepassing</li>
</ul>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../_images/IoT-rfm69-pakket.png"><img alt="../_images/IoT-rfm69-pakket.png" src="../_images/IoT-rfm69-pakket.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">RFM69 pakket met LPP payload</span></p>
</div>
<p>Het <em>hardware-protocol</em> zorgt voor:</p>
<ul class="simple">
<li>het adresseren (<em>destination</em>), zenden en ontvangen van pakketten;</li>
<li>het controleren van de CRC (cyclic redundancy check, checksum):
als deze klopt, concludeert de hardware dat het pakket correct ontvangen is;</li>
<li>het versleutelen en ontsleutelen van de payload (encryptie).</li>
</ul>
<p>Het protocol van de <em>RFM69-library</em> voegt het adres van de afzender (<em>source</em>) toe aan het pakket,
als eerste byte van de payload in het hardware-pakket.
Het protocol van de RFM69-library noemen we hier het <em>RFM69-protocol</em>.</p>
<p>Het RFM69-protocol gebruikt 5-bits adressen (0..63) voor de knopen in het netwerk.
De adressen 0, 61, 62 en 63 hebben een speciale betekenis.
RFM69-adres 0 als <em>destination</em> is het <em>broadcast address</em>: alle IoT-knopen in het RFM69-netwerk ontvangen zo’n bericht.</p>
<p>Het <em>toepassingsprotocol</em> gebruikt de rest van de hardware-payload.
Dit protocol gebruikt verschillende formaten voor uplink- en voor downlink-pakketten.
We bespreken hier alleen de binaire formaten op basis van het Cayenne <em>low power payload</em> (LPP) formaat.
Dit protocol noemen we hier het <em>appl:LPP</em> protocol.</p>
<p class="rubric"><em>appl:LPP</em> uplink-berichten</p>
<p>De payload voor uplink-berichten bevat de volgende elementen:</p>
<ul class="simple">
<li><em>port</em> (1 byte): dit geeft aan welk protocol gebruikt wordt voor de payload;
<code class="docutils literal notranslate"><span class="pre">port=1</span></code> geeft het LPP-formaat aan.</li>
<li><em>nodeid</em> (2 bytes): de identificatie van de knoop (gebruikt in het MQTT-topic);</li>
<li><em>counter</em> (2 bytes): het volgnummer van het bericht;
we gebruiken dit onder meer voor de veiligheid, om een <em>replay attack</em> te voorkomen.</li>
<li><dl class="first docutils">
<dt>LPP-<em>payload</em>, per sensor/actuator:</dt>
<dd><ul class="first last">
<li><em>channel</em> (1 byte): identificeert de sensor/actuator in de IoT-knoop;</li>
<li><em>type</em> (1 byte):type van de sensor/actuator;</li>
<li><em>value</em> (1 of meer bytes): de waarde(n) van de sensor (of actuator).</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Voorbeelden van sensor/actuatorgegevens in LPP-formaat:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">1</span></code>: channel=0 (LED 0), type=”dOut”, value=1 (“on”)</li>
<li><code class="docutils literal notranslate"><span class="pre">3,</span> <span class="pre">103,</span> <span class="pre">0,</span> <span class="pre">235</span></code>: channel=3, type=”temperature”, value=235 (23,5 ‘C)</li>
</ul>
<p>De waarde(n) van een sensor/actuator bestaat uit een reeks gehele getallen, van 1 of 2 bytes elk.
Door gehele getallen te gebruiken voorkomen we onder meer het (dure) rekenen met floating point getallen in de IoT-knoop.
Bovendien leveren de meeste sensoren een geheel getal als gemeten waarde:
het werken met floating point getallen voegt niets toe.</p>
<p>De types en de interpretatie van de data staan beschreven in de Cayenne-documentatie,
zie XXX</p>
<p>Enkele voorbeelden van veel voorkomende types sensoren en actuatoren:</p>
<table border="1" class="colwidths-given docutils" id="id3">
<caption><span class="caption-text">LPP types</span><a class="headerlink" href="#id3" title="Permalink naar deze tabel">¶</a></caption>
<colgroup>
<col width="31%" />
<col width="20%" />
<col width="10%" />
<col width="4%" />
<col width="4%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sensor</th>
<th class="head">Naam</th>
<th class="head">Type</th>
<th class="head">Hex</th>
<th class="head">Bytes</th>
<th class="head">Resolutie</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Digitale input</td>
<td>dIn</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>Digitale output</td>
<td>dOut</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="row-even"><td>Analoge input</td>
<td>aIn</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>0.01 Signed</td>
</tr>
<tr class="row-odd"><td>Analoge output</td>
<td>aOut</td>
<td>3</td>
<td>3</td>
<td>2</td>
<td>0.01 Signed</td>
</tr>
<tr class="row-even"><td>Lichtniveau</td>
<td>illuminance</td>
<td>101</td>
<td>65</td>
<td>2</td>
<td>1 Lux Unsigned</td>
</tr>
<tr class="row-odd"><td>Aanwezigheid</td>
<td>presence</td>
<td>102</td>
<td>66</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="row-even"><td>Temperatuur</td>
<td>temperature</td>
<td>103</td>
<td>67</td>
<td>2</td>
<td>0.1 °C Signed</td>
</tr>
<tr class="row-odd"><td>Rel. Luchtvochtigheid</td>
<td>humidity</td>
<td>104</td>
<td>68</td>
<td>1</td>
<td>0.5% Unsigned</td>
</tr>
<tr class="row-even"><td>Luchtdruk</td>
<td>barometer</td>
<td>115</td>
<td>73</td>
<td>2</td>
<td>0.1 hPa Unsigned</td>
</tr>
</tbody>
</table>
<p class="rubric"><em>appl_LPP</em> downlink-berichten</p>
<p>De payload voor een downlink-bericht is erg eenvoudig:</p>
<ul class="simple">
<li><em>port</em>: geeft het toepassingsprotocol aan; <code class="docutils literal notranslate"><span class="pre">port=1</span></code> staat voor de LPP payload;</li>
<li><dl class="first docutils">
<dt>de LPP-payload, per actuator:</dt>
<dd><ul class="first last">
<li><em>channel</em> (1 byte);</li>
<li><em>value</em> (1 of 2 bytes)</li>
</ul>
</dd>
</dl>
</li>
<li>een afsluiter (1 byte): <code class="docutils literal notranslate"><span class="pre">0xff</span></code> (geen geldig channel)</li>
</ul>
<p>We nemen hier het type van de actuator niet op: dit is in de knoop zelf bekend.
Ook de <em>nodeid</em> is niet nodig: de IoT-knoop kent zijn eigen <em>nodeid</em>.</p>
<ul class="simple">
<li>een <em>counter</em> (volgnummer) voor de veiligheid is wel nodig;???</li>
</ul>
</div>
<div class="section" id="gateway">
<h1>Gateway<a class="headerlink" href="#gateway" title="Permalink naar deze titel">¶</a></h1>
<p>De <em>gateway</em> koppelt het RFM69-netwerk aan het internet, meer in het bijzondere aan de IoT-toepassing via het MQTT-protocol.
Een RFM-IoT-knoop verstuurt RFM69-pakketten met daarin een IOT-toepassingspakket met een LPP-payload.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../_images/IoT-rfm69-keten-stacks.png"><img alt="../_images/IoT-rfm69-keten-stacks.png" src="../_images/IoT-rfm69-keten-stacks.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">Protocol-stacks in de RFM69-keten</span></p>
</div>
<p>De omzetting tussen de beide protocollen bestaat uit twee onderdelen:</p>
<ul class="simple">
<li>omzetten van de <em>adressering</em>: van RFM69-adres naar MQTT-topic (en omgekeerd);</li>
<li>omzetten van de <em>payload</em>: van RFM69-LPP-pakket naar MQTT-JSON bericht.</li>
</ul>
<p>Opmerking: de omzetting van de adressering voor <em>uplink</em>-berichten is eenvoudig:
de <em>nodeid</em> in het RFM69-LPP-pakket wordt ingevuld in het MQTT-topic <code class="docutils literal notranslate"><span class="pre">node/&lt;nodeid&gt;/sensors</span></code>.</p>
<p>Voor <em>downlink</em>-berichten is dit lastiger: in het IoT-toepassingsprotocol (MQTT/JSON) is het RFM69-adres onbekend.
De gateway houdt daarom een tabel bij: nodeid -&gt; RFM69-adres.
Als de gateway een RFM69-LPP-bericht ontvangt (in het formaat hierboven) wordt deze tabel bijgewerkt.
Als de gateway vervolgens een MQTT-bericht ontvangt voor een topic met de nodeid van een lokale node, wordt dit (na omzetting) verstuurd naar de bijbehorende RFM69-node.</p>
<hr class="docutils" />
<div class="admonition-gateway-versus-bridge admonition">
<p class="first admonition-title">Gateway versus bridge</p>
<p class="last">We maken hier onderscheid tussen ‘’gateways’’ en ‘’bridges’‘:
een bridge verbindt netwerken met eenzelfde protocol(stack),
een gateway verbindt netwerken met verschillende protocollen.
De omzetting in een bridge is dan beperkt tot de gemeenschappelijke onderste laag van de protocollen.
Bij een gateway moet je de hele protocolstack hierbij betrekken.
Een gateway is  vaak (aanzienlijk) complexer dan een bridge.
Bovendien hebben veranderingen in de toepassing mogelijk gevolgen voor de gateway.
Voor een bridge is de toepassing niet van belang.
Overigens wordt deze terminologie, met een duidelijk onderscheid tussen bridge en gateway,
niet overal op dezelfde manier gebruikt.</p>
</div>
<p>Ook als de IoT-knoop zelf de internet-protocolstack gebruikt kan het zinvol zijn om een bridge te gebruiken,
om de lokale communicatie te scheiden van het publieke internet.
Deze bridge kan er bijvoorbeeld zorgen voor de versleuteling van het verkeer naar het publieke internet.</p>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2019, SLO.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/rfm69/rfm69-keten.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>